{% extends "base.html" %}
{% block content %}
<h2>New Sale</h2>

<input type="text" id="searchItem" placeholder="Search product by name">
<div id="suggestions"></div>
<input type="number" id="quantity" placeholder="Quantity">
<input type="number" id="discount" placeholder="Discount (₦)">
<input type="number" id="payment" placeholder="Payment (₦)">
<button onclick="recordSale()">Record Sale</button>

<div id="saleMessage"></div>

<div id="printPreview">
    <div id="receiptContent"></div>
</div>

<script>
const suggestionsBox = document.getElementById('suggestions');

document.getElementById('searchItem').addEventListener('input', async function() {
    const query = this.value;
    if(!query) { suggestionsBox.style.display = 'none'; return; }

    const res = await fetch(`/search_product?q=${query}`);
    const products = await res.json();
    suggestionsBox.innerHTML = '';
    products.forEach(p => {
        const div = document.createElement('div');
        div.className = 'suggestion-item';
        div.textContent = p[0] + " - ₦" + p[1];
        div.onclick = () => { 
            document.getElementById('searchItem').value = p[0]; 
            suggestionsBox.style.display = 'none';
        };
        suggestionsBox.appendChild(div);
    });
    suggestionsBox.style.display = 'block';
});

async function recordSale() {
    const itemName = document.getElementById('searchItem').value;
    const quantity = parseInt(document.getElementById('quantity').value);
    const discount = parseFloat(document.getElementById('discount').value) || 0;
    const payment = parseFloat(document.getElementById('payment').value) || 0;

    const res = await fetch(`/search_product?q=${itemName}`);
    const products = await res.json();
    if(!products.length) { 
        document.getElementById('saleMessage').textContent = "Product not found!"; 
        return; 
    }
    const price = products[0][1];

    const saleRes = await fetch('/record_sale', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({
            item_name: itemName,
            price: price,
            quantity: quantity,
            discount: discount,
            payment: payment
        })
    });

    const result = await saleRes.json();
    document.getElementById('saleMessage').textContent = result.message;
    document.getElementById('receiptContent').textContent = `
M KANDI TEXTILE - QUALITY FABRICS AND MATERIALS
-----------------------------------------------
Item: ${itemName}
Price: ₦${price}
Quantity: ${quantity}
Discount: ₦${discount}
Payment: ₦${payment}
-----------------------------------------------
Thank you for your purchase!
`;
}
</script>
{% endblock %}
